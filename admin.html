<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuuskulista - Hallinta</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        h1 { color: #2c5f2d; margin-bottom: 20px; }
        .toolbar {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .toolbar button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #2c5f2d; color: white; }
        .btn-primary:hover { background: #1f4420; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .count { margin-left: auto; color: #666; }
        .status {
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
        }
        .status.success { display: block; background: #d4edda; color: #155724; }
        .status.error { display: block; background: #f8d7da; color: #721c24; }

        #resource-list {
            background: white;
            border-radius: 8px;
            padding: 10px;
        }
        .resource-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .resource-item:last-child { border-bottom: none; }
        .resource-item.dragging { opacity: 0.5; background: #e8f5e9; }
        .resource-item.drag-over { border-top: 3px solid #2c5f2d; }
        .drag-handle { color: #999; font-size: 20px; cursor: grab; }
        .resource-info { flex: 1; cursor: pointer; }
        .resource-info:hover .resource-title { color: #1f4420; text-decoration: underline; }
        .resource-title { font-weight: 600; color: #2c5f2d; }
        .resource-desc { font-size: 13px; color: #666; margin-top: 4px; }
        .resource-meta { font-size: 12px; color: #666; margin-top: 4px; }
        .resource-meta span {
            display: inline-block;
            background: #e0e0e0;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 5px;
        }
        .resource-actions { display: flex; gap: 5px; }
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 5px 8px;
            border-radius: 4px;
        }
        .action-btn:hover { background: #f0f0f0; }
        .action-btn.delete:hover { background: #fee; }
        .action-btn.open { color: #007bff; }
        .action-btn.edit { color: #28a745; }
        .action-btn.delete { color: #dc3545; }
        .loading { text-align: center; padding: 40px; color: #666; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 650px;
            width: 90%;
            max-height: 90vh;
            overflow: auto;
        }
        .modal-content h2 { color: #2c5f2d; margin-bottom: 20px; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .tab {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab:hover { color: #2c5f2d; }
        .tab.active {
            color: #2c5f2d;
            border-bottom-color: #2c5f2d;
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group textarea { height: 80px; resize: vertical; }
        .form-group textarea.json-input { height: 150px; font-family: monospace; font-size: 12px; }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2c5f2d;
        }
        .url-input-group {
            display: flex;
            gap: 10px;
        }
        .url-input-group input { flex: 1; }
        .url-input-group button { white-space: nowrap; }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .hint { font-size: 12px; color: #666; margin-top: 5px; }
        .spinner { display: inline-block; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>üêï Nuuskulista - Hallinta</h1>

    <div class="toolbar">
        <button class="btn-success" onclick="openAddModal()">‚ûï Lis√§√§ uusi</button>
        <button class="btn-primary" onclick="saveResources()">üíæ Tallenna</button>
        <button class="btn-secondary" onclick="loadResources()">üîÑ Lataa uudelleen</button>
        <span id="status" class="status"></span>
        <span class="count"><span id="count">0</span> resurssia</span>
    </div>

    <div id="resource-list">
        <div class="loading">Ladataan...</div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Lis√§√§ uusi resurssi</h2>

            <!-- Tabs (only shown for new resources) -->
            <div id="add-tabs" class="tabs">
                <button class="tab active" onclick="switchTab('form')">üìù Lomake</button>
                <button class="tab" onclick="switchTab('url')">üîó URL</button>
                <button class="tab" onclick="switchTab('json')">{ } JSON</button>
            </div>

            <!-- Tab 1: Form -->
            <div id="tab-form" class="tab-content active">
                <form id="resource-form">
                    <input type="hidden" id="edit-index" value="-1">

                    <div class="form-group">
                        <label for="edit-title">Nimi *</label>
                        <input type="text" id="edit-title" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-description">Kuvaus *</label>
                        <textarea id="edit-description" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="edit-category">Kategoria *</label>
                        <select id="edit-category" required>
                            <option value="podcast">Podcast</option>
                            <option value="video">Video</option>
                            <option value="article">Artikkeli</option>
                            <option value="course">Kurssi</option>
                            <option value="trainer">Kouluttaja</option>
                            <option value="shop">Verkkokauppa</option>
                            <option value="other">Muu</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="edit-language">Kieli *</label>
                        <select id="edit-language" required>
                            <option value="Suomi">Suomi</option>
                            <option value="Englanti">Englanti</option>
                            <option value="Ruotsi">Ruotsi</option>
                            <option value="Saksa">Saksa</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="edit-url">Linkki *</label>
                        <input type="url" id="edit-url" required placeholder="https://...">
                    </div>

                    <div class="modal-buttons">
                        <button type="button" class="btn-secondary" onclick="closeModal()">Peruuta</button>
                        <button type="submit" class="btn-primary">Tallenna</button>
                    </div>
                </form>
            </div>

            <!-- Tab 2: URL fetch -->
            <div id="tab-url" class="tab-content">
                <div class="form-group">
                    <label>Sy√∂t√§ URL</label>
                    <div class="url-input-group">
                        <input type="url" id="fetch-url" placeholder="https://...">
                        <button type="button" class="btn-primary" onclick="fetchFromUrl()">
                            <span id="fetch-btn-text">üîç Hae tiedot</span>
                        </button>
                    </div>
                    <p class="hint">LLM hakee sivun ja generoi otsikon, kuvauksen ja kategorian automaattisesti.</p>
                </div>
                <div id="fetch-result" style="display:none;">
                    <div class="form-group">
                        <label>Esikatselu</label>
                        <div id="fetch-preview" style="background:#f5f5f5; padding:15px; border-radius:5px;"></div>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn-secondary" onclick="closeModal()">Peruuta</button>
                        <button type="button" class="btn-success" onclick="addFetchedResource()">‚ûï Lis√§√§ resurssi</button>
                    </div>
                </div>
            </div>

            <!-- Tab 3: JSON -->
            <div id="tab-json" class="tab-content">
                <div class="form-group">
                    <label>Liit√§ JSON</label>
                    <textarea id="json-input" class="json-input" placeholder='{
    "title": "Resurssin nimi",
    "description": "Kuvaus",
    "category": "article",
    "language": "Suomi",
    "url": "https://..."
}'></textarea>
                    <p class="hint">Voit liitt√§√§ yhden resurssin tai taulukon useita resursseja.</p>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Peruuta</button>
                    <button type="button" class="btn-success" onclick="addFromJson()">‚ûï Lis√§√§ resurssi(t)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentResources = [];
        let draggedItem = null;
        let fetchedResource = null;

        async function loadResources() {
            try {
                const res = await fetch('/api/resources');
                const data = await res.json();
                currentResources = data.resources;
                render();
                showStatus('Ladattu!', 'success');
            } catch (err) {
                showStatus('Virhe ladattaessa: ' + err.message, 'error');
            }
        }

        async function saveResources() {
            try {
                const res = await fetch('/api/resources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ resources: currentResources })
                });
                const data = await res.json();
                if (data.success) {
                    showStatus('Tallennettu!', 'success');
                } else {
                    showStatus('Virhe: ' + data.error, 'error');
                }
            } catch (err) {
                showStatus('Virhe tallennettaessa: ' + err.message, 'error');
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            setTimeout(() => { status.className = 'status'; }, 3000);
        }

        function render() {
            const list = document.getElementById('resource-list');
            list.innerHTML = '';

            currentResources.forEach((resource, index) => {
                const item = document.createElement('div');
                item.className = 'resource-item';
                item.draggable = true;
                item.dataset.index = index;

                const flag = getFlag(resource.language);
                const category = getCategoryLabel(resource.category);

                item.innerHTML = `
                    <span class="drag-handle">‚ãÆ‚ãÆ</span>
                    <div class="resource-info" onclick="openEditModal(${index})">
                        <div class="resource-title">${resource.title}</div>
                        <div class="resource-desc">${truncate(resource.description, 80)}</div>
                        <div class="resource-meta">
                            <span>${category}</span>
                            <span>${flag} ${resource.language}</span>
                        </div>
                    </div>
                    <div class="resource-actions">
                        <button class="action-btn open" onclick="window.open('${resource.url}', '_blank')" title="Avaa linkki">üîó</button>
                        <button class="action-btn edit" onclick="openEditModal(${index})" title="Muokkaa">‚úèÔ∏è</button>
                        <button class="action-btn delete" onclick="deleteResource(${index})" title="Poista">‚úï</button>
                    </div>
                `;

                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragleave', handleDragLeave);

                list.appendChild(item);
            });

            document.getElementById('count').textContent = currentResources.length;
        }

        function truncate(str, len) {
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        // Drag & drop handlers
        function handleDragStart(e) { draggedItem = this; this.classList.add('dragging'); }
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.resource-item').forEach(item => item.classList.remove('drag-over'));
        }
        function handleDragOver(e) {
            e.preventDefault();
            if (this !== draggedItem) this.classList.add('drag-over');
        }
        function handleDragLeave(e) { this.classList.remove('drag-over'); }
        function handleDrop(e) {
            e.preventDefault();
            if (this !== draggedItem) {
                const fromIndex = parseInt(draggedItem.dataset.index);
                const toIndex = parseInt(this.dataset.index);
                const item = currentResources.splice(fromIndex, 1)[0];
                currentResources.splice(toIndex, 0, item);
                render();
            }
        }

        function deleteResource(index) {
            const resource = currentResources[index];
            if (confirm(`Poistetaanko "${resource.title}"?`)) {
                currentResources.splice(index, 1);
                render();
            }
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
        }

        // Modal functions
        function openAddModal() {
            document.getElementById('modal-title').textContent = 'Lis√§√§ uusi resurssi';
            document.getElementById('add-tabs').style.display = 'flex';
            document.getElementById('edit-index').value = -1;
            document.getElementById('edit-title').value = '';
            document.getElementById('edit-description').value = '';
            document.getElementById('edit-category').value = 'article';
            document.getElementById('edit-language').value = 'Suomi';
            document.getElementById('edit-url').value = '';
            document.getElementById('fetch-url').value = '';
            document.getElementById('fetch-result').style.display = 'none';
            document.getElementById('json-input').value = '';
            switchTab('form');
            document.getElementById('edit-modal').classList.add('active');
        }

        function openEditModal(index) {
            const resource = currentResources[index];
            document.getElementById('modal-title').textContent = 'Muokkaa resurssia';
            document.getElementById('add-tabs').style.display = 'none';
            switchTab('form');
            document.getElementById('edit-index').value = index;
            document.getElementById('edit-title').value = resource.title;
            document.getElementById('edit-description').value = resource.description;
            document.getElementById('edit-category').value = resource.category;
            document.getElementById('edit-language').value = resource.language;
            document.getElementById('edit-url').value = resource.url;
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        // Form submit
        document.getElementById('resource-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const index = parseInt(document.getElementById('edit-index').value);
            const resource = {
                title: document.getElementById('edit-title').value.trim(),
                description: document.getElementById('edit-description').value.trim(),
                category: document.getElementById('edit-category').value,
                language: document.getElementById('edit-language').value,
                url: document.getElementById('edit-url').value.trim()
            };

            if (index === -1) {
                currentResources.unshift(resource);
                showStatus('Resurssi lis√§tty!', 'success');
            } else {
                currentResources[index] = resource;
                showStatus('Resurssi p√§ivitetty!', 'success');
            }

            closeModal();
            render();
        });

        // URL fetch
        async function fetchFromUrl() {
            const url = document.getElementById('fetch-url').value.trim();
            if (!url) {
                alert('Sy√∂t√§ URL ensin');
                return;
            }

            const btn = document.getElementById('fetch-btn-text');
            btn.innerHTML = '<span class="spinner">‚è≥</span> Haetaan...';

            try {
                const res = await fetch('/api/fetch-resource', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();

                if (data.error) {
                    alert('Virhe: ' + data.error);
                    btn.textContent = 'üîç Hae tiedot';
                    return;
                }

                fetchedResource = data;
                const flag = getFlag(data.language);
                document.getElementById('fetch-preview').innerHTML = `
                    <strong>${data.title}</strong><br>
                    <small>${getCategoryLabel(data.category)} ¬∑ ${flag} ${data.language}</small><br><br>
                    ${data.description}<br><br>
                    <a href="${data.url}" target="_blank">${data.url}</a>
                `;
                document.getElementById('fetch-result').style.display = 'block';
                btn.textContent = 'üîç Hae tiedot';

            } catch (err) {
                alert('Virhe: ' + err.message);
                btn.textContent = 'üîç Hae tiedot';
            }
        }

        function addFetchedResource() {
            if (fetchedResource) {
                currentResources.unshift(fetchedResource);
                showStatus('Resurssi lis√§tty!', 'success');
                closeModal();
                render();
            }
        }

        // JSON import
        function addFromJson() {
            const jsonText = document.getElementById('json-input').value.trim();
            if (!jsonText) {
                alert('Liit√§ JSON ensin');
                return;
            }

            try {
                let data = JSON.parse(jsonText);

                // Handle single object or array
                if (!Array.isArray(data)) {
                    data = [data];
                }

                // Validate
                for (const r of data) {
                    if (!r.title || !r.description || !r.category || !r.language || !r.url) {
                        alert('JSON puuttuu pakollisia kentti√§ (title, description, category, language, url)');
                        return;
                    }
                }

                // Add all
                currentResources = [...data, ...currentResources];
                showStatus(`${data.length} resurssi(a) lis√§tty!`, 'success');
                closeModal();
                render();

            } catch (err) {
                alert('Virheellinen JSON: ' + err.message);
            }
        }

        // Close modal on escape/backdrop
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
        document.getElementById('edit-modal').addEventListener('click', e => { if (e.target.classList.contains('modal')) closeModal(); });

        function getFlag(language) {
            const flags = { 'Suomi': 'üá´üáÆ', 'Englanti': 'üá¨üáß', 'Saksa': 'üá©üá™', 'Ruotsi': 'üá∏üá™' };
            return flags[language] || 'üåê';
        }

        function getCategoryLabel(category) {
            const labels = { 'podcast': 'Podcast', 'video': 'Video', 'article': 'Artikkeli', 'course': 'Kurssi', 'trainer': 'Kouluttaja', 'shop': 'Verkkokauppa', 'other': 'Muu' };
            return labels[category] || category;
        }

        // Init
        loadResources();
    </script>
</body>
</html>
